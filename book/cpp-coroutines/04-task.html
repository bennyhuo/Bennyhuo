<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.bennyhuo.com/book/cpp-coroutines/04-task.html"><meta property="og:site_name" content="Benny Huo 的专栏"><meta property="og:title" content="4. 通用异步任务 Task"><meta property="og:description" content="协程主要用来降低异步任务的编写复杂度，异步任务各式各样，但归根结底就是一个结果的获取。 实现目标 为了方便介绍后续的内容，我们需要再定义一个类型 Task 来作为协程的返回值。Task 类型可以用来封装任何返回结果的异步行为（持续返回值的情况可能更适合使用序列生成器）。 实现的效果如下： 我们定义以 Task 为返回值类型的协程，并且可以在协程内部使用..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-16T15:04:10.000Z"><meta property="article:author" content="Benny Huo"><meta property="article:modified_time" content="2023-04-16T15:04:10.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"4. 通用异步任务 Task","image":[""],"dateModified":"2023-04-16T15:04:10.000Z","author":[{"@type":"Person","name":"Benny Huo","url":"https://www.bennyhuo.com"}]}</script><title>4. 通用异步任务 Task | Benny Huo 的专栏</title><meta name="description" content="协程主要用来降低异步任务的编写复杂度，异步任务各式各样，但归根结底就是一个结果的获取。 实现目标 为了方便介绍后续的内容，我们需要再定义一个类型 Task 来作为协程的返回值。Task 类型可以用来封装任何返回结果的异步行为（持续返回值的情况可能更适合使用序列生成器）。 实现的效果如下： 我们定义以 Task 为返回值类型的协程，并且可以在协程内部使用...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/book/assets/style-8cc3be1f.css" as="style"><link rel="stylesheet" href="/book/assets/style-8cc3be1f.css">
    <link rel="modulepreload" href="/book/assets/app-97ee009d.js"><link rel="modulepreload" href="/book/assets/framework-88b7ff58.js"><link rel="modulepreload" href="/book/assets/04-task.html-1620333f.js"><link rel="modulepreload" href="/book/assets/04-task.html-bb319bfb.js"><link rel="prefetch" href="/book/assets/index.html-7e02e0cc.js" as="script"><link rel="prefetch" href="/book/assets/conferences.html-446c0800.js" as="script"><link rel="prefetch" href="/book/assets/imooc.html-0e40865e.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-8424f486.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-e65ad28f.js" as="script"><link rel="prefetch" href="/book/assets/02-strictfp.html-dbe7efd8.js" as="script"><link rel="prefetch" href="/book/assets/03-random.html-afc8df36.js" as="script"><link rel="prefetch" href="/book/assets/04-mac.html-05c29b44.js" as="script"><link rel="prefetch" href="/book/assets/05-removed.html-fee3fbd8.js" as="script"><link rel="prefetch" href="/book/assets/06-internals.html-46b3557e.js" as="script"><link rel="prefetch" href="/book/assets/07-switch.html-200bb631.js" as="script"><link rel="prefetch" href="/book/assets/08-sealedclass.html-d60f67c7.js" as="script"><link rel="prefetch" href="/book/assets/09-foreignapi-memory.html-2affd912.js" as="script"><link rel="prefetch" href="/book/assets/10-foreignapi-callfunction.html-5ca7c4dc.js" as="script"><link rel="prefetch" href="/book/assets/11-vector.html-939f629c.js" as="script"><link rel="prefetch" href="/book/assets/12-contextserialfilter.html-2be37a62.js" as="script"><link rel="prefetch" href="/book/assets/index.html-e0181c9c.js" as="script"><link rel="prefetch" href="/book/assets/1104674.html-d1748d5f.js" as="script"><link rel="prefetch" href="/book/assets/1150253.html-5886b53f.js" as="script"><link rel="prefetch" href="/book/assets/245669.html-e5037583.js" as="script"><link rel="prefetch" href="/book/assets/375593.html-108f8bb3.js" as="script"><link rel="prefetch" href="/book/assets/378177.html-d73f9633.js" as="script"><link rel="prefetch" href="/book/assets/395051.html-f64accac.js" as="script"><link rel="prefetch" href="/book/assets/index.html-620078a1.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-093d22ff.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-770e6371.js" as="script"><link rel="prefetch" href="/book/assets/02-generator.html-2b6aab2e.js" as="script"><link rel="prefetch" href="/book/assets/03-functional.html-f11618a7.js" as="script"><link rel="prefetch" href="/book/assets/05-dispatcher.html-4f244adc.js" as="script"><link rel="prefetch" href="/book/assets/06-sleep.html-626111a9.js" as="script"><link rel="prefetch" href="/book/assets/07-channel.html-a3d63f6b.js" as="script"><link rel="prefetch" href="/book/assets/08-awaiter.html-96037d4e.js" as="script"><link rel="prefetch" href="/book/assets/09-http.html-6f5f256a.js" as="script"><link rel="prefetch" href="/book/assets/10-postscript.html-8f9c0849.js" as="script"><link rel="prefetch" href="/book/assets/index.html-e09c29fe.js" as="script"><link rel="prefetch" href="/book/assets/00-forword.html-baa7dd6e.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-b1fe58a7.js" as="script"><link rel="prefetch" href="/book/assets/02-start-mode.html-8b676b37.js" as="script"><link rel="prefetch" href="/book/assets/03-dispatchers.html-8c35fd84.js" as="script"><link rel="prefetch" href="/book/assets/04-exceptions.html-87f97643.js" as="script"><link rel="prefetch" href="/book/assets/05-cancellation.html-5fa13e78.js" as="script"><link rel="prefetch" href="/book/assets/06-suspend.html-be716b66.js" as="script"><link rel="prefetch" href="/book/assets/07-sequence.html-2be9dfaa.js" as="script"><link rel="prefetch" href="/book/assets/08-android.html-f6fa30c3.js" as="script"><link rel="prefetch" href="/book/assets/09-channel.html-c813b442.js" as="script"><link rel="prefetch" href="/book/assets/10-select.html-0f4f1183.js" as="script"><link rel="prefetch" href="/book/assets/11-flow.html-01e179c6.js" as="script"><link rel="prefetch" href="/book/assets/12-why-so-called-lightweight-thread.html-ad2eb523.js" as="script"><link rel="prefetch" href="/book/assets/13-implementations.html-eaf5fad0.js" as="script"><link rel="prefetch" href="/book/assets/index.html-abc8de6e.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-a156904e.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-9fb373ca.js" as="script"><link rel="prefetch" href="/book/assets/02-wrap-callback.html-c090e4b8.js" as="script"><link rel="prefetch" href="/book/assets/03-call-async-func.html-dfc1daf3.js" as="script"><link rel="prefetch" href="/book/assets/04-structured-concurrency.html-a43ebfba.js" as="script"><link rel="prefetch" href="/book/assets/05-cancellation.html-9d243a4e.js" as="script"><link rel="prefetch" href="/book/assets/06-actor.html-94d6373a.js" as="script"><link rel="prefetch" href="/book/assets/07-globalactor.html-191299ba.js" as="script"><link rel="prefetch" href="/book/assets/08-tasklocal.html-476ad127.js" as="script"><link rel="prefetch" href="/book/assets/09-interop.html-94882bf6.js" as="script"><link rel="prefetch" href="/book/assets/index.html-93aa55cf.js" as="script"><link rel="prefetch" href="/book/assets/404.html-8af28d87.js" as="script"><link rel="prefetch" href="/book/assets/index.html-ac839947.js" as="script"><link rel="prefetch" href="/book/assets/conferences.html-368faa6f.js" as="script"><link rel="prefetch" href="/book/assets/imooc.html-c6d8e443.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-b6f5877d.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-f929af19.js" as="script"><link rel="prefetch" href="/book/assets/02-strictfp.html-df446e18.js" as="script"><link rel="prefetch" href="/book/assets/03-random.html-ca456f72.js" as="script"><link rel="prefetch" href="/book/assets/04-mac.html-f5b1f4d3.js" as="script"><link rel="prefetch" href="/book/assets/05-removed.html-b739b255.js" as="script"><link rel="prefetch" href="/book/assets/06-internals.html-fa844fe4.js" as="script"><link rel="prefetch" href="/book/assets/07-switch.html-35a3a9c7.js" as="script"><link rel="prefetch" href="/book/assets/08-sealedclass.html-eb7f9283.js" as="script"><link rel="prefetch" href="/book/assets/09-foreignapi-memory.html-8f301cef.js" as="script"><link rel="prefetch" href="/book/assets/10-foreignapi-callfunction.html-9859aa2e.js" as="script"><link rel="prefetch" href="/book/assets/11-vector.html-a9cd9b66.js" as="script"><link rel="prefetch" href="/book/assets/12-contextserialfilter.html-0bed2861.js" as="script"><link rel="prefetch" href="/book/assets/index.html-a95965f0.js" as="script"><link rel="prefetch" href="/book/assets/1104674.html-389ac5bb.js" as="script"><link rel="prefetch" href="/book/assets/1150253.html-cfdfd69b.js" as="script"><link rel="prefetch" href="/book/assets/245669.html-65fbfc51.js" as="script"><link rel="prefetch" href="/book/assets/375593.html-8b9c48c2.js" as="script"><link rel="prefetch" href="/book/assets/378177.html-ffde26a2.js" as="script"><link rel="prefetch" href="/book/assets/395051.html-5edd3dc6.js" as="script"><link rel="prefetch" href="/book/assets/index.html-03212d7b.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-08bc37e9.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-62f542b7.js" as="script"><link rel="prefetch" href="/book/assets/02-generator.html-62962229.js" as="script"><link rel="prefetch" href="/book/assets/03-functional.html-aaabb6b6.js" as="script"><link rel="prefetch" href="/book/assets/05-dispatcher.html-8cc02892.js" as="script"><link rel="prefetch" href="/book/assets/06-sleep.html-ab44c6cb.js" as="script"><link rel="prefetch" href="/book/assets/07-channel.html-11557ab8.js" as="script"><link rel="prefetch" href="/book/assets/08-awaiter.html-93f3adcb.js" as="script"><link rel="prefetch" href="/book/assets/09-http.html-9f174eaa.js" as="script"><link rel="prefetch" href="/book/assets/10-postscript.html-1eabad7a.js" as="script"><link rel="prefetch" href="/book/assets/index.html-c82b8e6b.js" as="script"><link rel="prefetch" href="/book/assets/00-forword.html-2fc78bb7.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-22645be7.js" as="script"><link rel="prefetch" href="/book/assets/02-start-mode.html-79873faf.js" as="script"><link rel="prefetch" href="/book/assets/03-dispatchers.html-c088cb63.js" as="script"><link rel="prefetch" href="/book/assets/04-exceptions.html-6832b57d.js" as="script"><link rel="prefetch" href="/book/assets/05-cancellation.html-b2eed520.js" as="script"><link rel="prefetch" href="/book/assets/06-suspend.html-96e117ae.js" as="script"><link rel="prefetch" href="/book/assets/07-sequence.html-a435a29e.js" as="script"><link rel="prefetch" href="/book/assets/08-android.html-8ff6d246.js" as="script"><link rel="prefetch" href="/book/assets/09-channel.html-b45b8cc4.js" as="script"><link rel="prefetch" href="/book/assets/10-select.html-362b78e4.js" as="script"><link rel="prefetch" href="/book/assets/11-flow.html-83ee7a27.js" as="script"><link rel="prefetch" href="/book/assets/12-why-so-called-lightweight-thread.html-452177c6.js" as="script"><link rel="prefetch" href="/book/assets/13-implementations.html-b2a1387f.js" as="script"><link rel="prefetch" href="/book/assets/index.html-d0a124ad.js" as="script"><link rel="prefetch" href="/book/assets/00-foreword.html-aa8b2cc3.js" as="script"><link rel="prefetch" href="/book/assets/01-intro.html-998cfeea.js" as="script"><link rel="prefetch" href="/book/assets/02-wrap-callback.html-668ba972.js" as="script"><link rel="prefetch" href="/book/assets/03-call-async-func.html-175f23ef.js" as="script"><link rel="prefetch" href="/book/assets/04-structured-concurrency.html-29eb58b6.js" as="script"><link rel="prefetch" href="/book/assets/05-cancellation.html-82c68475.js" as="script"><link rel="prefetch" href="/book/assets/06-actor.html-63a82bc4.js" as="script"><link rel="prefetch" href="/book/assets/07-globalactor.html-e27d4c47.js" as="script"><link rel="prefetch" href="/book/assets/08-tasklocal.html-79b839ff.js" as="script"><link rel="prefetch" href="/book/assets/09-interop.html-4e637285.js" as="script"><link rel="prefetch" href="/book/assets/index.html-64f082af.js" as="script"><link rel="prefetch" href="/book/assets/404.html-ec85a8af.js" as="script"><link rel="prefetch" href="/book/assets/giscus-2f1671b8.js" as="script"><link rel="prefetch" href="/book/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/book/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/book/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/book/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/book/assets/reveal.esm-ab04f0b1.js" as="script"><link rel="prefetch" href="/book/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/book/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/book/assets/photoswipe.esm-36cd6c3c.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/book/cpp-coroutines/https://www.bennyhuo.com/" class="brand"><img class="logo" src="https://www.bennyhuo.com/assets/avatar.jpg" alt="Benny Huo 的专栏"><!----><span class="site-name hide-in-pad">Benny Huo 的专栏</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/book/" class="nav-link sidebar-link sidebar-page" aria-label="专栏首页"><!---->专栏首页<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/conferences.html" class="nav-link sidebar-link sidebar-page" aria-label="会议分享"><!---->会议分享<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/imooc.html" class="nav-link sidebar-link sidebar-page" aria-label="视频课程"><!---->视频课程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">视频连载</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><!----><span class="title">渡劫 C++ 协程</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/book/cpp-coroutines/00-foreword.html" class="nav-link sidebar-link sidebar-page" aria-label="0. 前言"><!---->0. 前言<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/01-intro.html" class="nav-link sidebar-link sidebar-page" aria-label="1. C++ 协程概览"><!---->1. C++ 协程概览<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/02-generator.html" class="nav-link sidebar-link sidebar-page" aria-label="2. 实现一个序列生成器"><!---->2. 实现一个序列生成器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/03-functional.html" class="nav-link sidebar-link sidebar-page" aria-label="3. 序列生成器的泛化和函数式变换"><!---->3. 序列生成器的泛化和函数式变换<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/book/cpp-coroutines/04-task.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="4. 通用异步任务 Task"><!---->4. 通用异步任务 Task<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#实现目标" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="实现目标"><!---->实现目标<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#结果类型的定义" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="结果类型的定义"><!---->结果类型的定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#promise-type-的定义" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="promise_type 的定义"><!---->promise_type 的定义<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#基本结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="基本结构"><!---->基本结构<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#await-transform" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="await_transform"><!---->await_transform<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#同步阻塞获取结果" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="同步阻塞获取结果"><!---->同步阻塞获取结果<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#异步结果回调" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="异步结果回调"><!---->异步结果回调<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#task-的实现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Task 的实现"><!---->Task 的实现<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#task-的-void-特化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Task 的 void 特化"><!---->Task 的 void 特化<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#小试牛刀" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="小试牛刀"><!---->小试牛刀<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#小结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="小结"><!---->小结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#关于作者" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="关于作者"><!---->关于作者<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/05-dispatcher.html" class="nav-link sidebar-link sidebar-page" aria-label="5. 协程的调度器"><!---->5. 协程的调度器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/06-sleep.html" class="nav-link sidebar-link sidebar-page" aria-label="6. 基于协程的挂起实现无阻塞的 sleep"><!---->6. 基于协程的挂起实现无阻塞的 sleep<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/07-channel.html" class="nav-link sidebar-link sidebar-page" aria-label="7. 用于协程之间消息传递的 Channel"><!---->7. 用于协程之间消息传递的 Channel<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/08-awaiter.html" class="nav-link sidebar-link sidebar-page" aria-label="8. 通用 Awaiter"><!---->8. 通用 Awaiter<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/09-http.html" class="nav-link sidebar-link sidebar-page" aria-label="9. 一个简单的示例"><!---->9. 一个简单的示例<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/book/cpp-coroutines/10-postscript.html" class="nav-link sidebar-link sidebar-page" aria-label="10. 后记"><!---->10. 后记<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">Java 17 版本更新</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">破解 Kotlin 协程</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">闲话 Swift 协程</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->4. 通用异步任务 Task</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.bennyhuo.com" target="_blank" rel="noopener noreferrer">Benny Huo</a></span><span property="author" content="Benny Huo"></span></span><!----><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-03-24T11:56:31.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 11 分钟</span><meta property="timeRequired" content="PT11M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#实现目标" class="router-link-active router-link-exact-active toc-link level2">实现目标</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#结果类型的定义" class="router-link-active router-link-exact-active toc-link level2">结果类型的定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#promise-type-的定义" class="router-link-active router-link-exact-active toc-link level2">promise_type 的定义</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#基本结构" class="router-link-active router-link-exact-active toc-link level3">基本结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#await-transform" class="router-link-active router-link-exact-active toc-link level3">await_transform</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#同步阻塞获取结果" class="router-link-active router-link-exact-active toc-link level3">同步阻塞获取结果</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#异步结果回调" class="router-link-active router-link-exact-active toc-link level3">异步结果回调</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#task-的实现" class="router-link-active router-link-exact-active toc-link level2">Task 的实现</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#task-的-void-特化" class="router-link-active router-link-exact-active toc-link level2">Task 的 void 特化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#小试牛刀" class="router-link-active router-link-exact-active toc-link level2">小试牛刀</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#小结" class="router-link-active router-link-exact-active toc-link level2">小结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/book/cpp-coroutines/04-task.html#关于作者" class="router-link-active router-link-exact-active toc-link level2">关于作者</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="_4-通用异步任务-task" tabindex="-1"><a class="header-anchor" href="#_4-通用异步任务-task" aria-hidden="true">#</a> 4. 通用异步任务 Task</h1><blockquote><p>协程主要用来降低异步任务的编写复杂度，异步任务各式各样，但归根结底就是一个结果的获取。</p></blockquote><!--[--><div class="bili-desc"><a class="sr-only" href="https://player.bilibili.com/player.html?bvid=BV163411g7np&amp;t=0&amp;autoplay=0">A BiliBili video</a></div><iframe src="https://player.bilibili.com/player.html?bvid=BV163411g7np&amp;t=0&amp;autoplay=0" title="A BiliBili video" class="bili-iframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; fullscreen; gyroscope; picture-in-picture" style="width:100%;height:auto;"></iframe><!--]--><h2 id="实现目标" tabindex="-1"><a class="header-anchor" href="#实现目标" aria-hidden="true">#</a> 实现目标</h2><p>为了方便介绍后续的内容，我们需要再定义一个类型 <code>Task</code> 来作为协程的返回值。<code>Task</code> 类型可以用来封装任何返回结果的异步行为（持续返回值的情况可能更适合使用序列生成器）。</p><p>实现的效果如下：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// sleep 1 秒</span>
  <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token double-colon punctuation">::</span>chrono_literals<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token number">1</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">co_return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// sleep 2 秒</span>
  <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token double-colon punctuation">::</span>chrono_literals<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token number">2</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">co_return</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// result2 == 2</span>
  <span class="token keyword">auto</span> result2 <span class="token operator">=</span> <span class="token keyword">co_await</span> <span class="token function">simple_task2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// result3 == 3</span>
  <span class="token keyword">auto</span> result3 <span class="token operator">=</span> <span class="token keyword">co_await</span> <span class="token function">simple_task3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">co_return</span> <span class="token number">1</span> <span class="token operator">+</span> result2 <span class="token operator">+</span> result3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们定义以 <code>Task&lt;ResultType&gt;</code> 为返回值类型的协程，并且可以在协程内部使用 <code>co_await</code> 来等待其他 <code>Task</code> 的执行。</p><p>外部非协程内的函数当中访问 <code>Task</code> 的结果时，我们可以通过回调或者同步阻塞调用两种方式来实现：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> simpleTask <span class="token operator">=</span> <span class="token function">simple_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 异步方式</span>
  simpleTask<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// i == 6</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catching</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 同步方式</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> i <span class="token operator">=</span> simpleTask<span class="token punctuation">.</span><span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// i == 6</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>按照这个效果，我们大致可以分析得到：</p><ol><li>需要一个结果类型来承载正常返回和异常抛出的情况。</li><li>需要为 <code>Task</code> 定义相应的 <code>promise_type</code> 类型来支持 <code>co_return</code> 和 <code>co_await</code>。</li><li>为 <code>Task</code> 实现获取结果的阻塞函数 <code>get_result</code> 或者用于获取返回值的回调 <code>then</code> 以及用于获取抛出的异常的回调 <code>catching</code>。</li></ol><h2 id="结果类型的定义" tabindex="-1"><a class="header-anchor" href="#结果类型的定义" aria-hidden="true">#</a> 结果类型的定义</h2><p>描述 <code>Task</code> 正常返回的结果和抛出的异常，只需要定义一个持有二者的类型即可：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Result</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化为默认值</span>
  <span class="token keyword">explicit</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token comment">// 当 Task 正常返回时用结果初始化 Result</span>
  <span class="token keyword">explicit</span> <span class="token function">Result</span><span class="token punctuation">(</span>T <span class="token operator">&amp;&amp;</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 当 Task 抛异常时用异常初始化 Result</span>
  <span class="token keyword">explicit</span> <span class="token function">Result</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception_ptr <span class="token operator">&amp;&amp;</span>exception_ptr<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_exception_ptr</span><span class="token punctuation">(</span>exception_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 读取结果，有异常则抛出异常</span>
  T <span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_exception_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span><span class="token function">rethrow_exception</span><span class="token punctuation">(</span>_exception_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  T _value<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>exception_ptr _exception_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，<code>Result</code> 的模板参数 <code>T</code> 对应于 <code>Task</code> 的返回值类型。有了这个结果类型，我们就可以很方便地在需要读取结果的时候调用 <code>get_or_throw</code>。</p><h2 id="promise-type-的定义" tabindex="-1"><a class="header-anchor" href="#promise-type-的定义" aria-hidden="true">#</a> promise_type 的定义</h2><p>promise_type 的定义自然是最为重要的部分。</p><h3 id="基本结构" tabindex="-1"><a class="header-anchor" href="#基本结构" aria-hidden="true">#</a> 基本结构</h3><p>基于前面几篇文章的基础，我们能够<s>很轻松地</s>给出它的基本结构：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ResultType</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskPromise</span> <span class="token punctuation">{</span>
  <span class="token comment">// 协程立即执行</span>
  std<span class="token double-colon punctuation">::</span>suspend_never <span class="token function">initial_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 执行结束后挂起，等待外部销毁。该逻辑与前面的 Generator 类似</span>
  std<span class="token double-colon punctuation">::</span>suspend_always <span class="token function">final_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 构造协程的返回值对象 Task</span>
  Task<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span> <span class="token function">get_return_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span><span class="token class-name">coroutine_handle</span><span class="token operator">&lt;</span>TaskPromise<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">from_promise</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将异常存入 result</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">return_value</span><span class="token punctuation">(</span>ResultType value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将返回值存入 result，对应于协程内部的 &#39;co_return value&#39;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 使用 std::optional 可以区分协程是否执行完成</span>
  std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Result<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;&gt;</span> result<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="await-transform" tabindex="-1"><a class="header-anchor" href="#await-transform" aria-hidden="true">#</a> await_transform</h3><p>光有这些还不够，我们还需要为 <code>Task</code> 添加 <code>co_await</code> 的支持。这里我们有两个选择：</p><ol><li>为 <code>Task</code> 实现 <code>co_await</code> 运算符</li><li>在 <code>promise_type</code> 当中定义 <code>await_transform</code></li></ol><p>从效果上来看，二者都可以做到。但区别在于，<code>await_transform</code> 是 <code>promsie_type</code> 的内部函数，可以直接访问到 <code>promise</code> 内部的状态；同时，<code>await_transform</code> 的定义也会限制协程内部对于其他类型的 <code>co_await</code> 的支持，将协程内部的挂起行为更好的管控起来，方便后续我们做统一的线程调度。因此此处我们采用 <code>await_transform</code> 来为 <code>Task</code> 提供 <code>co_await</code> 支持：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ResultType</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskPromise</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// 注意这里的模板参数</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_ResultType</span><span class="token operator">&gt;</span>
  TaskAwaiter<span class="token operator">&lt;</span>_ResultType<span class="token operator">&gt;</span> <span class="token function">await_transform</span><span class="token punctuation">(</span>Task<span class="token operator">&lt;</span>_ResultType<span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">TaskAwaiter</span><span class="token generic class-name"><span class="token operator">&lt;</span>_ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码很简单，返回了一个 <code>TaskAwaiter</code> 的对象。不过再次请大家注意，这里存在两个 <code>Task</code>，一个是 <code>TaskPromise</code> 对应的 <code>Task</code>，一个是 <code>co_await</code> 表达式的操作数 <code>Task</code>，后者是 <code>await_transform</code> 的参数。</p><p>下面是 <code>TaskAwaiter</code> 的定义：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskAwaiter</span> <span class="token punctuation">{</span>
  <span class="token keyword">explicit</span> <span class="token function">TaskAwaiter</span><span class="token punctuation">(</span>Task<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>task<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
      <span class="token operator">:</span> <span class="token function">task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">TaskAwaiter</span><span class="token punctuation">(</span>TaskAwaiter <span class="token operator">&amp;&amp;</span>completion<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
      <span class="token operator">:</span> <span class="token function">task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">exchange</span><span class="token punctuation">(</span>completion<span class="token punctuation">.</span>task<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">TaskAwaiter</span><span class="token punctuation">(</span>TaskAwaiter <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  TaskAwaiter <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>TaskAwaiter <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token keyword">constexpr</span> <span class="token keyword">bool</span> <span class="token function">await_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">await_suspend</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>coroutine_handle<span class="token operator">&lt;</span><span class="token operator">&gt;</span> handle<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当 task 执行完之后调用 resume</span>
    task<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">[</span>handle<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      handle<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 协程恢复执行时，被等待的 Task 已经执行完，调用 get_result 来获取结果</span>
  R <span class="token function">await_resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> task<span class="token punctuation">.</span><span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  Task<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span> task<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当一个 <code>Task</code> 实例被 co_await 时，意味着它在 co_await 表达式返回之前已经执行完毕，当 <code>co_await</code> 表达式返回时，<code>Task</code> 的结果也就被取到，<code>Task</code> 实例在后续就没有意义了。因此 <code>TaskAwaiter</code> 的构造器当中接收 <code>Task &amp;&amp;</code>，防止 <code>co_await</code> 表达式之后继续对 <code>Task</code> 进行操作。</p><h3 id="同步阻塞获取结果" tabindex="-1"><a class="header-anchor" href="#同步阻塞获取结果" aria-hidden="true">#</a> 同步阻塞获取结果</h3><p>为了防止 <code>result</code> 被外部随意访问，我们特意将其改为私有成员。接下来我们还需要提供相应的方式方便外部访问 <code>result</code>。</p><p>先来看一下如何实现同步阻塞的结果返回：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ResultType</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskPromise</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通知 get_result 当中的 wait</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">return_value</span><span class="token punctuation">(</span>ResultType value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通知 get_result 当中的 wait</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ResultType <span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 result 没有值，说明协程还没有运行完，等待值被写入再返回</span>
    std<span class="token double-colon punctuation">::</span>unique_lock <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 等待写入值之后调用 notify_all</span>
      completion<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果有值，则直接返回（或者抛出异常）</span>
    <span class="token keyword">return</span> result<span class="token operator">-&gt;</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Result<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;&gt;</span> result<span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>mutex completion_lock<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>condition_variable completion<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>既然要阻塞，就免不了用到锁（mutex）和条件变量（condition_variable），熟悉它们的读者一定觉得事情变得不那么简单了：这些工具在以往都是用在多线程并发的环境当中的。我们现在这么写其实也是为了后续应对多线程的场景，有关多线程调度的问题我们将在下一篇文章当中讨论。</p><h3 id="异步结果回调" tabindex="-1"><a class="header-anchor" href="#异步结果回调" aria-hidden="true">#</a> 异步结果回调</h3><p>异步回调的实现稍微复杂一些，其实主要复杂在对于函数的运用。实际上对于回调的支持，主要就是支持回调的注册和回调的调用。根据结果类型的不同，回调又分为返回值的回调或者抛出异常的回调：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ResultType</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskPromise</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用回调</span>
    <span class="token function">notify_callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">return_value</span><span class="token punctuation">(</span>ResultType value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用回调</span>
    <span class="token function">notify_callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">on_completed</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Result<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_lock <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加锁判断 result</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// result 已经有值</span>
      <span class="token keyword">auto</span> value <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 解锁之后再调用 func</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">func</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 否则添加回调函数，等待调用</span>
      completion_callbacks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// 回调列表，我们允许对同一个 Task 添加多个回调</span>
  std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Result<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span> completion_callbacks<span class="token punctuation">;</span>
  
  <span class="token keyword">void</span> <span class="token function">notify_callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> value <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>callback <span class="token operator">:</span> completion_callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用完成，清空回调</span>
    completion_callbacks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样地，如果只是在单线程环境内运行协程，这里的异步回调的作用可能并不明显。这里只是先给出定义，待我们后续支持线程调度之后，这些回调支持就会非常有价值了。</p><h2 id="task-的实现" tabindex="-1"><a class="header-anchor" href="#task-的实现" aria-hidden="true">#</a> Task 的实现</h2><p>现在我们已经实现了最为关键的 <code>promise_type</code>，接下来给出 <code>Task</code> 类型的完整定义。我想各位读者一定明白，<code>Task</code> 不过就是个摆设，它的能力大多都是通过调用 <code>promise_type</code> 来实现的。</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ResultType</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>

  <span class="token comment">// 声明 promise_type 为 TaskPromise 类型</span>
  <span class="token keyword">using</span> promise_type <span class="token operator">=</span> TaskPromise<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  ResultType <span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Task <span class="token operator">&amp;</span><span class="token function">then</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>ResultType<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on_completed</span><span class="token punctuation">(</span><span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 忽略异常</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Task <span class="token operator">&amp;</span><span class="token function">catching</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on_completed</span><span class="token punctuation">(</span><span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 忽略返回值</span>
        result<span class="token punctuation">.</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Task <span class="token operator">&amp;</span><span class="token function">finally</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on_completed</span><span class="token punctuation">(</span><span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">explicit</span> <span class="token function">Task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">&gt;</span> handle<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token operator">:</span> <span class="token function">handle</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">Task</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;&amp;</span>task<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token operator">:</span> <span class="token function">handle</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">exchange</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>handle<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">Task</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  Task <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">)</span> handle<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">&gt;</span> handle<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在我们完成了 <code>Task</code> 的第一个通用版本的实现，这个版本的实现当中尽管我们对 <code>Task</code> 的结果做了加锁，但考虑到目前我们仍没有提供线程切换的能力，因此这实际上是一个无调度器版本的 <code>Task</code> 实现。</p><h2 id="task-的-void-特化" tabindex="-1"><a class="header-anchor" href="#task-的-void-特化" aria-hidden="true">#</a> Task 的 void 特化</h2><p>前面讨论的 <code>Task</code> 有一个作为返回值类型的模板参数 <code>ResultType</code>。实际上有些时候我们只是希望一段任务可以异步执行完，而不关注它的结果，这时候 <code>ResultType</code> 就需要是 <code>void</code>。例如：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">Producer</span><span class="token punctuation">(</span>Channel<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但很快你就会发现问题。编译器会告诉你模板实例化错误，因为我们没法用 <code>void</code> 来声明变量；编译器还会告诉你协程体里面如果没有返回值，你应该提供为 <code>promise_type</code> 提供 <code>return_void</code> 函数。</p><p>看来情况没有那么简单。C++ 的模板经常会遇到这种需要特化的情况，我们只需要对之前的 <code>Task&lt;ResultType&gt;</code> 版本的定义稍作修改，就可以给出 <code>Task&lt;void&gt;</code> 的版本：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用 void 作为第一个模板参数实例化 TaskPromise</span>
  <span class="token keyword">using</span> promise_type <span class="token operator">=</span> TaskPromise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回 void</span>
  <span class="token keyword">void</span> <span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为是 void，因此不用 return</span>
    <span class="token comment">// 这时这个函数的作用就是阻塞当前线程等待协程执行完成</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// func 的类型参数 void()，注意之前这个模板类型构造器还有个参数 ResultType</span>
  Task <span class="token operator">&amp;</span><span class="token function">then</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on_completed</span><span class="token punctuation">(</span><span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 我们也会对 result 做 void 版本的实例化，这里只是检查有没有异常抛出</span>
        result<span class="token punctuation">.</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ignore.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Task <span class="token operator">&amp;</span><span class="token function">catching</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on_completed</span><span class="token punctuation">(</span><span class="token punctuation">[</span>func<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你会发现变化的只是跟结果相关的部分。相应的，<code>TaskPromise</code> 也需要做出修改：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskPromise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// 注意 Task 的模板参数</span>
  Task<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">get_return_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span><span class="token class-name">coroutine_handle</span><span class="token operator">&lt;</span>TaskPromise<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">from_promise</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// 返回值类型改成 void</span>
  <span class="token keyword">void</span> <span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 不再需要 return</span>
    result<span class="token operator">-&gt;</span><span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Result 的模板参数变化</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">notify_callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 不再是 return_value 了</span>
  <span class="token keyword">void</span> <span class="token function">return_void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard <span class="token function">lock</span><span class="token punctuation">(</span>completion_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Result</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    completion<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">notify_callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注意 Result 的模板参数 void </span>
  <span class="token keyword">void</span> <span class="token function">on_completed</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Result<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 注意 Result 的模板参数 void</span>
  std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Result<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;&gt;</span> result<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Result<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span> completion_callbacks<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还有 <code>Result</code> 也有对应的 <code>void</code> 实例化版本，其实就是把存储返回值相关的逻辑全部删掉，只保留异常相关的部分：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">explicit</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token keyword">explicit</span> <span class="token function">Result</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception_ptr <span class="token operator">&amp;&amp;</span>exception_ptr<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_exception_ptr</span><span class="token punctuation">(</span>exception_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">get_or_throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_exception_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span><span class="token function">rethrow_exception</span><span class="token punctuation">(</span>_exception_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>exception_ptr _exception_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，我们进一步完善了 <code>Task</code> 对不同类型的结果的支持，理论上我们可以使用 <code>Task</code> 来构建各式各样的协程了。</p><h2 id="小试牛刀" tabindex="-1"><a class="header-anchor" href="#小试牛刀" aria-hidden="true">#</a> 小试牛刀</h2><p>接下来我们可以试着把文章开头的代码运行一下了。为了更仔细地观察程序的执行，我们也在一些节点打印了日志：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;task 2 start ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token double-colon punctuation">::</span>chrono_literals<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token number">1</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;task 2 returns after 1s.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">co_return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;in task 3 start ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token double-colon punctuation">::</span>chrono_literals<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span><span class="token number">2</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;task 3 returns after 2s.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">co_return</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">simple_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;task start ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> result2 <span class="token operator">=</span> <span class="token keyword">co_await</span> <span class="token function">simple_task2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;returns from task2: &quot;</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> result3 <span class="token operator">=</span> <span class="token keyword">co_await</span> <span class="token function">simple_task3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;returns from task3: &quot;</span><span class="token punctuation">,</span> result3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">co_return</span> <span class="token number">1</span> <span class="token operator">+</span> result2 <span class="token operator">+</span> result3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> simpleTask <span class="token operator">=</span> <span class="token function">simple_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  simpleTask<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;simple task end: &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catching</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;error occurred&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> i <span class="token operator">=</span> simpleTask<span class="token punctuation">.</span><span class="token function">get_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;simple task end from get: &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;error: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>debug</code> 是我自定义的一个宏，可以在打印日志的时候附加上时间、线程、函数等信息，运行结果如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>16:46:30.448 [Thread-25132] (main.cpp:40) simple_task: task start ...
16:46:30.449 [Thread-25132] (main.cpp:24) simple_task2: task 2 start ...
16:46:31.459 [Thread-25132] (main.cpp:27) simple_task2: task 2 returns after 1s.
16:46:31.460 [Thread-25132] (main.cpp:42) simple_task: returns from task2:  2
16:46:31.461 [Thread-25132] (main.cpp:32) simple_task3: in task 3 start ...
16:46:33.469 [Thread-25132] (main.cpp:35) simple_task3: task 3 returns after 2s.
16:46:33.470 [Thread-25132] (main.cpp:44) simple_task: returns from task3:  3
16:46:33.471 [Thread-25132] (main.cpp:51) operator (): simple task end:  6
16:46:33.471 [Thread-25132] (main.cpp:57) main: simple task end from get:  6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于我们的任务在执行过程中没有进行任何线程切换，因此各个 <code>Task</code> 的执行实际上是串行的，就如同我们调用普通函数一样。当然，这显然不是我们的最终目的，下一篇我们就来介绍如何给 <code>Task</code> 增加调度器的支持。</p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p>本文我们详细介绍了无调度器版本的 <code>Task</code> 的实现。尽管程序尚未真正实现异步执行，但至少从形式上，我们已经非常接近协程最神奇的地方了。</p><h2 id="关于作者" tabindex="-1"><a class="header-anchor" href="#关于作者" aria-hidden="true">#</a> 关于作者</h2><p><strong>霍丙乾 bennyhuo</strong>，Google 开发者专家（Kotlin 方向）；<strong>《深入理解 Kotlin 协程》</strong> 作者（机械工业出版社，2020.6）；<strong>《深入实践 Kotlin 元编程》</strong> 作者（机械工业出版社，预计 2023 Q3）；前腾讯高级工程师，现就职于猿辅导</p><ul><li>GitHub：https://github.com/bennyhuo</li><li>博客：https://www.bennyhuo.com</li><li>bilibili：<a href="https://space.bilibili.com/28615855" target="_blank" rel="noopener noreferrer"><strong>霍丙乾 bennyhuo</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>微信公众号：<strong>霍丙乾 bennyhuo</strong></li></ul></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: bennyhuo@kotliner.cn">bennyhuo</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/book/cpp-coroutines/03-functional.html" class="nav-link prev" aria-label="3. 序列生成器的泛化和函数式变换"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->3. 序列生成器的泛化和函数式变换</div></a><a href="/book/cpp-coroutines/05-dispatcher.html" class="nav-link next" aria-label="5. 协程的调度器"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">5. 协程的调度器<!----></div></a></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><!----><div class="copyright">bennyhuo@2018-2023</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/book/assets/app-97ee009d.js" defer></script>
  </body>
</html>
